select sum(price * (1-discount)*(1+tax)) as totalOrderPrice from lineitem where orderkey = 1;

SET SESSION join_distribution_type = 'PARTITIONED';

explain (type distributed)
select o.clerk as clerkName, count(item.linenumber) as items, sum(item.quantity) as quantities
from orders as o, lineitem as item
where o.orderkey = item.orderkey and o.orderdate = item.receiptdate
group by o.clerk 
order by items desc 
limit 10;


PushPartialAggregationThroughExchange


Logical Plan
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 - Output[clerkName, items, quantities] => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                                     
         clerkName := clerk (1:16)                                                                                                                                                                                                                                       
         items := count (1:38)                                                                                                                                                                                                                                           
         quantities := sum (1:71)                                                                                                                                                                                                                                        
     - TopN[10 by (count DESC_NULLS_LAST)] => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                                  
         - LocalExchange[SINGLE] () => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                                         
             - RemoteStreamingExchange[GATHER] => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                              
                 - TopNPartial[10 by (count DESC_NULLS_LAST)] => [clerk:varchar, sum:double, count:bigint]                                                                                                                                                               
                     - Project[projectLocality = LOCAL] => [clerk:varchar, sum:double, count:bigint]                                                                                                                                                                     
                         - Aggregate(FINAL)[clerk][$hashvalue] => [clerk:varchar, $hashvalue:bigint, sum:double, count:bigint]                                                                                                                                           
                                 sum := "presto.default.sum"((sum_15)) (1:71)                                                                                                                                                                                            
                                 count := "presto.default.count"((count_14)) (1:38)                                                                                                                                                                                      
                             - LocalExchange[HASH][$hashvalue] (clerk) => [clerk:varchar, sum_15:double, count_14:bigint, $hashvalue:bigint]                                                                                                                             
                                 - RemoteStreamingExchange[REPARTITION][$hashvalue_16] => [clerk:varchar, sum_15:double, count_14:bigint, $hashvalue_16:bigint]                                                                                                          
                                     - Aggregate(PARTIAL)[clerk][$hashvalue_22] => [clerk:varchar, $hashvalue_22:bigint, sum_15:double, count_14:bigint]                                                                                                                 
                                             sum_15 := "presto.default.sum"((quantity)) (1:71)                                                                                                                                                                           
                                             count_14 := "presto.default.count"((linenumber)) (1:38)                                                                                                                                                                     
                                         - Project[projectLocality = LOCAL] => [clerk:varchar, linenumber:bigint, quantity:double, $hashvalue_22:bigint]                                                                                                                 
                                                 $hashvalue_22 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(clerk), BIGINT'0')) (4:10)                                                                                                                        
                                             - InnerJoin[("orderkey" = "orderkey_0") AND ("orderdate" = "receiptdate")][$hashvalue_17, $hashvalue_19] => [clerk:varchar, linenumber:bigint, quantity:double]                                                             
                                                     Distribution: PARTITIONED                                                                                                                                                                                           
                                                 - RemoteStreamingExchange[REPARTITION][$hashvalue_17] => [orderkey:bigint, orderdate:varchar, clerk:varchar, $hashvalue_17:bigint]                                                                                      
                                                         Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                      
                                                     - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, projectLocality = LOCAL] => [orderkey:bigint, orderdate:varchar, clerk:var
                                                             Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                            
                                                             $hashvalue_18 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')), COALESCE($operator$hash_code(orderdate), BIGINT'0')) (2:6)                                       
                                                             orderdate := ExampleColumnHandle{connectorId=example, columnName=orderdate, columnType=varchar, ordinalPosition=4} (2:6)                                                                                    
                                                             orderkey := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (2:6)                                                                                       
                                                             clerk := ExampleColumnHandle{connectorId=example, columnName=clerk, columnType=varchar, ordinalPosition=6} (2:6)                                                                                            
                                                 - LocalExchange[HASH][$hashvalue_19] (orderkey_0, receiptdate) => [orderkey_0:bigint, linenumber:bigint, quantity:double, receiptdate:varchar, $hashvalue_19:bigint]                                                    
                                                         Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                      
                                                     - RemoteStreamingExchange[REPARTITION][$hashvalue_20] => [orderkey_0:bigint, linenumber:bigint, quantity:double, receiptdate:varchar, $hashvalue_20:bigint]                                                         
                                                             Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                  
                                                         - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:lineitem', layout='Optional[example:tpch:lineitem]'}, projectLocality = LOCAL] => [orderkey_0:bigint, linenumber:bigint,
                                                                 Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                        
                                                                 $hashvalue_21 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey_0), BIGINT'0')), COALESCE($operator$hash_code(receiptdate), BIGINT'0')) (2:19)                              
                                                                 orderkey_0 := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (2:19)                                                                                
                                                                 quantity := ExampleColumnHandle{connectorId=example, columnName=quantity, columnType=double, ordinalPosition=4} (2:19)                                                                                  
                                                                 receiptdate := ExampleColumnHandle{connectorId=example, columnName=receiptdate, columnType=varchar, ordinalPosition=12} (2:19)                                                                          
                                                                 linenumber := ExampleColumnHandle{connectorId=example, columnName=linenumber, columnType=bigint, ordinalPosition=3} (2:19)                                                                              
                                                                                                                                                                                                                                                                         
(1 row)

Distributed Plan
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Fragment 0 [SINGLE]                                                                                                                                                                                                                                                     
     Output layout: [clerk, count, sum]                                                                                                                                                                                                                                  
     Output partitioning: SINGLE []                                                                                                                                                                                                                                      
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - Output[clerkName, items, quantities] => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                                 
             clerkName := clerk (2:8)                                                                                                                                                                                                                                    
             items := count (2:30)                                                                                                                                                                                                                                       
             quantities := sum (2:63)                                                                                                                                                                                                                                    
         - TopN[10 by (count DESC_NULLS_LAST)] => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                              
             - LocalExchange[SINGLE] () => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                                     
                 - RemoteSource[1] => [clerk:varchar, count:bigint, sum:double]                                                                                                                                                                                          

 // See: https://prestodb.io/docs/current/sql/explain.html
 // HASH: Fragment is executed on a fixed number of nodes with the input data distributed using a hash function.
 // fragment的类型由依赖的RemoteStreamingExchange类型决定：
 //   AddLocalExchanges#visitTopN (生成ExchangeNode)
 //    -> AddLocalExchanges#planAndEnforceChildren 
 //      -> AddLocalExchanges#planAndEnforce
 //        -> AddLocalExchanges#enforce
 //   PlanFragmenter$Fragmenter#createRemoteStreamingExchange (处理到ExchangeNode，便会递归调用)
 //   PlanFragmenter$Fragmenter#visitTableScan (设置SOURCE_DISTRIBUTION)                                                                                                                                                                                                                 
 Fragment 1 [HASH]                                                                                                                                                                                                                                                       
     Output layout: [clerk, count, sum]                                                                                                                                                                                                                                  
     Output partitioning: SINGLE []                                                                                                                                                                                                                                      
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - TopNPartial[10 by (count DESC_NULLS_LAST)] => [clerk:varchar, sum:double, count:bigint]                                                                                                                                                                           
         - Project[projectLocality = LOCAL] => [clerk:varchar, sum:double, count:bigint]                                                                                                                                                                                 
             - Aggregate(FINAL)[clerk][$hashvalue] => [clerk:varchar, $hashvalue:bigint, sum:double, count:bigint]                                                                                                                                                       
                     sum := "presto.default.sum"((sum_15)) (2:63)                                                                                                                                                                                                        
                     count := "presto.default.count"((count_14)) (2:30)                                                                                                                                                                                                  
                 - LocalExchange[HASH][$hashvalue] (clerk) => [clerk:varchar, sum_15:double, count_14:bigint, $hashvalue:bigint]                                                                                                                                         
                     - RemoteSource[2] => [clerk:varchar, sum_15:double, count_14:bigint, $hashvalue_16:bigint]                                                                                                                                                          
                                                                                                                                                                                                                                                                         
 Fragment 2 [HASH]                                                                                                                                                                                                                                                       
     Output layout: [clerk, sum_15, count_14, $hashvalue_22]                                                                                                                                                                                                             
     Output partitioning: HASH [clerk][$hashvalue_22]                                                                                                                                                                                                                    
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - Aggregate(PARTIAL)[clerk][$hashvalue_22] => [clerk:varchar, $hashvalue_22:bigint, sum_15:double, count_14:bigint]                                                                                                                                                 
             sum_15 := "presto.default.sum"((quantity)) (2:63)                                                                                                                                                                                                           
             count_14 := "presto.default.count"((linenumber)) (2:30)                                                                                                                                                                                                     
         - Project[projectLocality = LOCAL] => [clerk:varchar, linenumber:bigint, quantity:double, $hashvalue_22:bigint]                                                                                                                                                 
                 $hashvalue_22 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(clerk), BIGINT'0')) (5:10)                                                                                                                                                        
             - InnerJoin[("orderkey" = "orderkey_0") AND ("orderdate" = "receiptdate")][$hashvalue_17, $hashvalue_19] => [clerk:varchar, linenumber:bigint, quantity:double]                                                                                             
                     Distribution: PARTITIONED                                                                                                                                                                                                                           
                 - RemoteSource[3] => [orderkey:bigint, orderdate:varchar, clerk:varchar, $hashvalue_17:bigint]                                                                                                                                                          
                 - LocalExchange[HASH][$hashvalue_19] (orderkey_0, receiptdate) => [orderkey_0:bigint, linenumber:bigint, quantity:double, receiptdate:varchar, $hashvalue_19:bigint]                                                                                    
                         Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                                                      
                     - RemoteSource[4] => [orderkey_0:bigint, linenumber:bigint, quantity:double, receiptdate:varchar, $hashvalue_20:bigint]                                                                                                                             
                                                                                                                                                                                                                                                                         
 Fragment 3 [SOURCE]                                                                                                                                                                                                                                                     
     Output layout: [orderkey, orderdate, clerk, $hashvalue_18]                                                                                                                                                                                                          
     Output partitioning: HASH [orderkey, orderdate][$hashvalue_18]                                                                                                                                                                                                      
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, grouped = false, projectLocality = LOCAL] => [orderkey:bigint, orderdate:varchar, clerk:varchar, $hashvalue_18:bigint]    
             Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                                                                            
             $hashvalue_18 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')), COALESCE($operator$hash_code(orderdate), BIGINT'0')) (3:6)                                                                                       
             orderdate := ExampleColumnHandle{connectorId=example, columnName=orderdate, columnType=varchar, ordinalPosition=4} (3:6)                                                                                                                                    
             orderkey := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (3:6)                                                                                                                                       
             clerk := ExampleColumnHandle{connectorId=example, columnName=clerk, columnType=varchar, ordinalPosition=6} (3:6)                                                                                                                                            
                                                                                                                                                                                                                                                                         
 Fragment 4 [SOURCE]                                                                                                                                                                                                                                                     
     Output layout: [orderkey_0, linenumber, quantity, receiptdate, $hashvalue_21]                                                                                                                                                                                       
     Output partitioning: HASH [orderkey_0, receiptdate][$hashvalue_21]                                                                                                                                                                                                  
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:lineitem', layout='Optional[example:tpch:lineitem]'}, grouped = false, projectLocality = LOCAL] => [orderkey_0:bigint, linenumber:bigint, quantity:double, receiptdate:varch
             Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                                                                            
             $hashvalue_21 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey_0), BIGINT'0')), COALESCE($operator$hash_code(receiptdate), BIGINT'0')) (3:19)                                                                                  
             orderkey_0 := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (3:19)                                                                                                                                    
             quantity := ExampleColumnHandle{connectorId=example, columnName=quantity, columnType=double, ordinalPosition=4} (3:19)                                                                                                                                      
             receiptdate := ExampleColumnHandle{connectorId=example, columnName=receiptdate, columnType=varchar, ordinalPosition=12} (3:19)                                                                                                                              
             linenumber := ExampleColumnHandle{connectorId=example, columnName=linenumber, columnType=bigint, ordinalPosition=3} (3:19)                                                                                                                                  
                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                         
(1 row)
