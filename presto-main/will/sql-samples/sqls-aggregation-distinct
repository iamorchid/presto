1)
explain (type distributed)
select count(distinct(clerk)) from orders;

                                                                                                                 Query Plan                                                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Fragment 0 [SINGLE]                                                                                                                                                                                                                        
     Output layout: [count]                                                                                                                                                                                                                 
     Output partitioning: SINGLE []                                                                                                                                                                                                         
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                          
     - Output[PlanNodeId 8][_col0] => [count:bigint]                                                                                                                                                                                        
             _col0 := count (2:8)                                                                                                                                                                                                           
         - Aggregate(FINAL)[PlanNodeId 3] => [count:bigint]                                                                                                                                                                                 
                 count := "presto.default.count"((count_4)) (2:8)                                                                                                                                                                           
             - LocalExchange[PlanNodeId 280][SINGLE] () => [count_4:bigint]                                                                                                                                                                 
                 - RemoteSource[1] => [count_4:bigint]                                                                                                                                                                                      
                                                                                                                                                                                                                                            
 Fragment 1 [HASH]                                                                                                                                                                                                                          
     Output layout: [count_4]                                                                                                                                                                                                               
     Output partitioning: SINGLE []                                                                                                                                                                                                         
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                          
     - Aggregate(PARTIAL)[PlanNodeId 284] => [count_4:bigint]                                                                                                                                                                               
             count_4 := "presto.default.count"((clerk)) (2:8)                                                                                                                                                                               
         - Aggregate(FINAL)[clerk][$hashvalue][PlanNodeId 49] => [clerk:varchar(15), $hashvalue:bigint]                                                                                                                                     
             - LocalExchange[PlanNodeId 296][HASH][$hashvalue] (clerk) => [clerk:varchar(15), $hashvalue:bigint]                                                                                                                            
                 - RemoteSource[2] => [clerk:varchar(15), $hashvalue_5:bigint]                                                                                                                                                              
                                                                                                                                                                                                                                            
 Fragment 2 [tpch:orders:15000]                                                                                                                                                                                                             
     Output layout: [clerk, $hashvalue_6]                                                                                                                                                                                                   
     Output partitioning: HASH [clerk][$hashvalue_6]                                                                                                                                                                                        
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                          
     - Aggregate(PARTIAL)[clerk][$hashvalue_6][PlanNodeId 300] => [clerk:varchar(15), $hashvalue_6:bigint]                                                                                                                                  
         - ScanProject[PlanNodeId 0,341][table = TableHandle {connectorId='tpch', connectorHandle='orders:sf0.01', layout='Optional[orders:sf0.01]'}, grouped = false, projectLocality = LOCAL] => [clerk:varchar(15), $hashvalue_6:bigint] 
                 Estimates: {source: CostBasedSourceInfo, rows: 15,000 (424.80kB), cpu: 300,000.00, memory: 0.00, network: 0.00}/{source: CostBasedSourceInfo, rows: 15,000 (424.80kB), cpu: 735,000.00, memory: 0.00, network: 0.00}       
                 $hashvalue_6 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(clerk), BIGINT'0')) (2:8)                                                                                                                             
                 clerk := tpch:clerk (2:36)                                                                                                                                                                                                 
                 tpch:orderstatus                                                                                                                                                                                                           
                     :: [["F"], ["O"], ["P"]]                                                                                                                                                                                               
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                            
(1 row)


2)

# SingleDistinctAggregationToGroupBy

explain
select orderdate, count(distinct(clerk)) from orders group by orderdate;

                                                                                                                                   Query Plan                                                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 - Output[orderdate, _col1] => [orderdate:varchar, count:bigint]                                                                                                                                                                                       
         _col1 := count (2:19)                                                                                                                                                                                                                         
     - RemoteStreamingExchange[GATHER] => [orderdate:varchar, count:bigint]                                                                                                                                                                            
         - Project[projectLocality = LOCAL] => [orderdate:varchar, count:bigint]                                                                                                                                                                       
             - Aggregate(FINAL)[orderdate][$hashvalue] => [orderdate:varchar, $hashvalue:bigint, count:bigint]                                                                                                                                         
                     count := "presto.default.count"((count_9)) (2:19)                                                                                                                                                                                 
                 - LocalExchange[HASH][$hashvalue] (orderdate) => [orderdate:varchar, count_9:bigint, $hashvalue:bigint]                                                                                                                               
                     - RemoteStreamingExchange[REPARTITION][$hashvalue_10] => [orderdate:varchar, count_9:bigint, $hashvalue_10:bigint]                                                                                                                
                         - Aggregate(PARTIAL)[orderdate][$hashvalue_14] => [orderdate:varchar, $hashvalue_14:bigint, count_9:bigint]                                                                                                                   
                                 count_9 := "presto.default.count"((clerk)) (2:19)                                                                                                                                                                     
                             - Project[projectLocality = LOCAL] => [orderdate:varchar, clerk:varchar, $hashvalue_14:bigint]                                                                                                                            
                                     $hashvalue_14 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')) (2:63)                                                                                                              
                                 - Aggregate(FINAL)[orderdate, clerk][$hashvalue_11] => [orderdate:varchar, clerk:varchar, $hashvalue_11:bigint]                                                                                                       
                                     - LocalExchange[HASH][$hashvalue_11] (orderdate, clerk) => [orderdate:varchar, clerk:varchar, $hashvalue_11:bigint]                                                                                               
                                         - RemoteStreamingExchange[REPARTITION][$hashvalue_12] => [orderdate:varchar, clerk:varchar, $hashvalue_12:bigint]                                                                                             
                                             - Aggregate(PARTIAL)[orderdate, clerk][$hashvalue_13] => [orderdate:varchar, clerk:varchar, $hashvalue_13:bigint]                                                                                         
                                                 - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, projectLocality = LOCAL] => [orderdate:varchar, clerk:varcha
                                                         Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                              
                                                         $hashvalue_13 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')), COALESCE($operator$hash_code(clerk), BIGINT'0')) (2:63)                           
                                                         orderdate := ExampleColumnHandle{connectorId=example, columnName=orderdate, columnType=varchar, ordinalPosition=4} (2:47)                                                                     
                                                         clerk := ExampleColumnHandle{connectorId=example, columnName=clerk, columnType=varchar, ordinalPosition=6} (2:47) 


3)
SET SESSION aggregation_partitioning_merging_strategy = 'TOP_DOWN';

explain
select orderdate, count(distinct(clerk)) from orders group by orderdate;

                                                                                                                               Query Plan                                                                                                              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 - Output[orderdate, _col1] => [orderdate:varchar, count:bigint]                                                                                                                                                                                       
         _col1 := count (1:27)                                                                                                                                                                                                                         
     - RemoteStreamingExchange[GATHER] => [orderdate:varchar, count:bigint]                                                                                                                                                                            
         - Project[projectLocality = LOCAL] => [orderdate:varchar, count:bigint]                                                                                                                                                                       
             - Aggregate[orderdate][$hashvalue_14] => [orderdate:varchar, $hashvalue_14:bigint, count:bigint]                                                                                                                                          
                     count := "presto.default.count"((clerk)) (1:27)                                                                                                                                                                                   
                 - Project[projectLocality = LOCAL] => [orderdate:varchar, clerk:varchar, $hashvalue_14:bigint]                                                                                                                                        
                         $hashvalue_14 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')) (1:71)                                                                                                                          
                     - Aggregate(FINAL)[orderdate, clerk][$hashvalue] => [orderdate:varchar, clerk:varchar, $hashvalue:bigint]                                                                                                                         
                         - LocalExchange[HASH][$hashvalue_9] (orderdate) => [orderdate:varchar, clerk:varchar, $hashvalue:bigint, $hashvalue_9:bigint]                                                                                                 
                             - RemoteStreamingExchange[REPARTITION][$hashvalue_11] => [orderdate:varchar, clerk:varchar, $hashvalue_10:bigint, $hashvalue_11:bigint]                                                                                   
                                 - Project[projectLocality = LOCAL] => [orderdate:varchar, clerk:varchar, $hashvalue_12:bigint, $hashvalue_13:bigint]                                                                                                  
                                         $hashvalue_13 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')) (1:71)                                                                                                          
                                     - Aggregate(PARTIAL)[orderdate, clerk][$hashvalue_12] => [orderdate:varchar, clerk:varchar, $hashvalue_12:bigint]                                                                                                 
                                         - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, projectLocality = LOCAL] => [orderdate:varchar, clerk:varchar, $hash
                                                 Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                      
                                                 $hashvalue_12 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')), COALESCE($operator$hash_code(clerk), BIGINT'0')) (1:71)                                   
                                                 orderdate := ExampleColumnHandle{connectorId=example, columnName=orderdate, columnType=varchar, ordinalPosition=4} (1:55)                                                                             
                                                 clerk := ExampleColumnHandle{connectorId=example, columnName=clerk, columnType=varchar, ordinalPosition=6} (1:55)                                                                                     
                                                                                                                                                                                                                                                       
(1 row)

4)

# MultipleDistinctAggregationToMarkDistinct
explain
select orderdate, count(distinct(clerk)), count(distinct(orderkey)) from orders group by orderdate;

                                                                                                                                                              Query Plan                                                                                                 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 - Output[orderdate, _col1, _col2] => [orderdate:date, count:bigint, count_3:bigint]                                                                                                                                                                                     
         _col1 := count (2:19)                                                                                                                                                                                                                                           
         _col2 := count_3 (2:43)                                                                                                                                                                                                                                         
     - RemoteStreamingExchange[GATHER] => [orderdate:date, count_3:bigint, count:bigint]                                                                                                                                                                                 
         - Project[projectLocality = LOCAL] => [orderdate:date, count_3:bigint, count:bigint]                                                                                                                                                                            
             - Aggregate(FINAL)[orderdate][$hashvalue] => [orderdate:date, $hashvalue:bigint, count_3:bigint, count:bigint]                                                                                                                                              
                     count_3 := "presto.default.count"((count_17)) (2:43)                                                                                                                                                                                                
                     count := "presto.default.count"((count_18)) (2:19)                                                                                                                                                                                                  
                 - LocalExchange[HASH][$hashvalue] (orderdate) => [orderdate:date, count_18:bigint, count_17:bigint, $hashvalue:bigint]                                                                                                                                  
                     - RemoteStreamingExchange[REPARTITION][$hashvalue_19] => [orderdate:date, count_18:bigint, count_17:bigint, $hashvalue_19:bigint]                                                                                                                   
                         - Aggregate(PARTIAL)[orderdate][$hashvalue_20] => [orderdate:date, $hashvalue_20:bigint, count_18:bigint, count_17:bigint]                                                                                                                      
                                 count_18 := "presto.default.count"((clerk)) (mask = clerk_15) (2:19)                                                                                                                                                                    
                                 count_17 := "presto.default.count"((orderkey)) (mask = orderkey_16) (2:43)                                                                                                                                                              
                             - MarkDistinct[distinct=orderdate:date, orderkey:bigint marker=orderkey_16][$hashvalue_21] => [orderkey:bigint, orderdate:date, clerk:varchar(15), clerk_15:boolean, $hashvalue_20:bigint, $hashvalue_21:bigint, orderkey_16:boolean]       
                                 - LocalExchange[HASH][$hashvalue_21] (orderdate, orderkey) => [orderkey:bigint, orderdate:date, clerk:varchar(15), clerk_15:boolean, $hashvalue_20:bigint, $hashvalue_21:bigint]                                                        
                                     - RemoteStreamingExchange[REPARTITION][$hashvalue_23] => [orderkey:bigint, orderdate:date, clerk:varchar(15), clerk_15:boolean, $hashvalue_22:bigint, $hashvalue_23:bigint]                                                         
                                         - Project[projectLocality = LOCAL] => [orderkey:bigint, orderdate:date, clerk:varchar(15), $hashvalue_24:bigint, $hashvalue_25:bigint, clerk_15:boolean]                                                                        
                                             - MarkDistinct[distinct=orderdate:date, clerk:varchar(15) marker=clerk_15][$hashvalue_26] => [orderkey:bigint, orderdate:date, clerk:varchar(15), $hashvalue_24:bigint, $hashvalue_25:bigint, $hashvalue_26:bigint, clerk_15
                                                 - LocalExchange[HASH][$hashvalue_26] (orderdate, clerk) => [orderkey:bigint, orderdate:date, clerk:varchar(15), $hashvalue_24:bigint, $hashvalue_25:bigint, $hashvalue_26:bigint]                                       
                                                         Estimates: {rows: 15000 (336.91kB), cpu: 3255000.00, memory: 0.00, network: 915000.00}                                                                                                                          
                                                     - RemoteStreamingExchange[REPARTITION][$hashvalue_29] => [orderkey:bigint, orderdate:date, clerk:varchar(15), $hashvalue_27:bigint, $hashvalue_28:bigint, $hashvalue_29:bigint]                                     
                                                             Estimates: {rows: 15000 (336.91kB), cpu: 2340000.00, memory: 0.00, network: 915000.00}                                                                                                                      
                                                         - ScanProject[table = TableHandle {connectorId='tpch', connectorHandle='orders:sf0.01', layout='Optional[orders:sf0.01]'}, projectLocality = LOCAL] => [orderkey:bigint, orderdate:date, clerk:varchar(15), $has
                                                                 Estimates: {rows: 15000 (336.91kB), cpu: 510000.00, memory: 0.00, network: 0.00}/{rows: 15000 (336.91kB), cpu: 1425000.00, memory: 0.00, network: 0.00}                                                 
                                                                 $hashvalue_30 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')) (2:74)                                                                                                    
                                                                 $hashvalue_31 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')), COALESCE($operator$hash_code(orderkey), BIGINT'0')) (2:74)                                  
                                                                 $hashvalue_32 := combine_hash(combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderdate), BIGINT'0')), COALESCE($operator$hash_code(clerk), BIGINT'0')) (2:74)                                     
                                                                 clerk := tpch:clerk (2:74)                                                                                                                                                                              
                                                                 orderdate := tpch:orderdate (2:74)                                                                                                                                                                      
                                                                 orderkey := tpch:orderkey (2:74)                                                                                                                                                                        
                                                                 tpch:orderstatus                                                                                                                                                                                        
                                                                     :: [["F"], ["O"], ["P"]]                                                                                                                                                                            
                                                                                                                                                                                                                                                                         
(1 row)
