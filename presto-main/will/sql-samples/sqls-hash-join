## 使用example catalog

SET SESSION join_distribution_type = 'PARTITIONED';

#### case #1

explain (type distributed)
select o.orderkey as orderName, count(item.linenumber) as items, sum(item.quantity) as quantities
from orders as o, lineitem as item
where o.orderkey = item.orderkey
group by o.orderkey 
order by items desc 
limit 10;


Logical Plan
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 - Output[orderName, items, quantities] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                                   
         orderName := orderkey (1:16)                                                                                                                                                                                                                                    
         items := count (1:41)                                                                                                                                                                                                                                           
         quantities := sum (1:74)                                                                                                                                                                                                                                        
     - TopN[10 by (count DESC_NULLS_LAST)] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                                
         - LocalExchange[SINGLE] () => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                                       
             - RemoteStreamingExchange[GATHER] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                            
                 - TopNPartial[10 by (count DESC_NULLS_LAST)] => [orderkey:bigint, sum:double, count:bigint]
                     # InnerJoin和Aggregate(FINAL)之间没有引入RemoteStreamingExchange，因为IndexJoin的join keys满足
                     # group by keys的要求，可以不用进行shuffle。                                                                                                                                                             
                     - Aggregate(FINAL)[orderkey] => [orderkey:bigint, sum:double, count:bigint]                                                                                                                                                                         
                             sum := "presto.default.sum"((sum_15)) (1:74)                                                                                                                                                                                                
                             count := "presto.default.count"((count_14)) (1:41)                                                                                                                                                                                          
                         - LocalExchange[HASH][$hashvalue] (orderkey) => [orderkey:bigint, sum_15:double, count_14:bigint, $hashvalue:bigint]                                                                                                                            
                             - Project[projectLocality = LOCAL] => [orderkey:bigint, sum_15:double, count_14:bigint, $hashvalue_21:bigint]                                                                                                                               
                                     $hashvalue_21 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')) (1:184)                                                                                                                                
                                 # 在没有引入RemoteStreamingExchange，这里添加partitial aggregate是否还有必要？？
                                 - Aggregate(PARTIAL)[orderkey] => [orderkey:bigint, sum_15:double, count_14:bigint]                                                                                                                                                     
                                         sum_15 := "presto.default.sum"((quantity)) (1:74)                                                                                                                                                                               
                                         count_14 := "presto.default.count"((linenumber)) (1:41)                                                                                                                                                                         
                                     - InnerJoin[("orderkey" = "orderkey_0")][$hashvalue_16, $hashvalue_18] => [orderkey:bigint, linenumber:bigint, quantity:double]                                                                                                     
                                             Distribution: PARTITIONED                                                                                                                                                                                                   
                                         - RemoteStreamingExchange[REPARTITION][$hashvalue_16] => [orderkey:bigint, $hashvalue_16:bigint]                                                                                                                                
                                                 Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                              
                                             - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, projectLocality = LOCAL] => [orderkey:bigint, $hashvalue_17:bigint]               
                                                     Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                                    
                                                     $hashvalue_17 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')) (1:112)                                                                                                                
                                                     orderkey := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (1:112)                                                                                             
                                         - LocalExchange[HASH][$hashvalue_18] (orderkey_0) => [orderkey_0:bigint, linenumber:bigint, quantity:double, $hashvalue_18:bigint]                                                                                              
                                                 Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                              
                                             - RemoteStreamingExchange[REPARTITION][$hashvalue_19] => [orderkey_0:bigint, linenumber:bigint, quantity:double, $hashvalue_19:bigint]                                                                                      
                                                     Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                          
                                                 - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:lineitem', layout='Optional[example:tpch:lineitem]'}, projectLocality = LOCAL] => [orderkey_0:bigint, linenumber:bigint, quantit
                                                         Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                                
                                                         $hashvalue_20 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey_0), BIGINT'0')) (1:125)                                                                                                          
                                                         orderkey_0 := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (1:125)                                                                                       
                                                         quantity := ExampleColumnHandle{connectorId=example, columnName=quantity, columnType=double, ordinalPosition=4} (1:125)                                                                                         
                                                         linenumber := ExampleColumnHandle{connectorId=example, columnName=linenumber, columnType=bigint, ordinalPosition=3} (1:125)                                                                                     
                                                                                                                                                                                                                                                                         
(1 row)


Distributed Plan
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Fragment 0 [SINGLE]                                                                                                                                                                                                                                                     
     Output layout: [orderkey, count, sum]                                                                                                                                                                                                                               
     Output partitioning: SINGLE []                                                                                                                                                                                                                                      
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - Output[orderName, items, quantities] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                               
             orderName := orderkey (2:8)                                                                                                                                                                                                                                 
             items := count (2:33)                                                                                                                                                                                                                                       
             quantities := sum (2:66)                                                                                                                                                                                                                                    
         - TopN[10 by (count DESC_NULLS_LAST)] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                            
             - LocalExchange[SINGLE] () => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                                   
                 - RemoteSource[1] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                                        
                                                                                                                                                                                                                                                                         
 Fragment 1 [HASH]                                                                                                                                                                                                                                                       
     Output layout: [orderkey, count, sum]                                                                                                                                                                                                                               
     Output partitioning: SINGLE []                                                                                                                                                                                                                                      
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - TopNPartial[10 by (count DESC_NULLS_LAST)] => [orderkey:bigint, sum:double, count:bigint]                                                                                                                                                                         
         - Aggregate(FINAL)[orderkey] => [orderkey:bigint, sum:double, count:bigint]                                                                                                                                                                                     
                 sum := "presto.default.sum"((sum_15)) (2:66)                                                                                                                                                                                                            
                 count := "presto.default.count"((count_14)) (2:33)                                                                                                                                                                                                      
             - LocalExchange[HASH][$hashvalue] (orderkey) => [orderkey:bigint, sum_15:double, count_14:bigint, $hashvalue:bigint]                                                                                                                                        
                 - Project[projectLocality = LOCAL] => [orderkey:bigint, sum_15:double, count_14:bigint, $hashvalue_21:bigint]                                                                                                                                           
                         $hashvalue_21 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')) (5:10)                                                                                                                                             
                     - Aggregate(PARTIAL)[orderkey] => [orderkey:bigint, sum_15:double, count_14:bigint]                                                                                                                                                                 
                             sum_15 := "presto.default.sum"((quantity)) (2:66)                                                                                                                                                                                           
                             count_14 := "presto.default.count"((linenumber)) (2:33)                                                                                                                                                                                     
                         - InnerJoin[("orderkey" = "orderkey_0")][$hashvalue_16, $hashvalue_18] => [orderkey:bigint, linenumber:bigint, quantity:double]                                                                                                                 
                                 Distribution: PARTITIONED                                                                                                                                                                                                               
                             - RemoteSource[2] => [orderkey:bigint, $hashvalue_16:bigint]                                                                                                                                                                                
                             - LocalExchange[HASH][$hashvalue_18] (orderkey_0) => [orderkey_0:bigint, linenumber:bigint, quantity:double, $hashvalue_18:bigint]                                                                                                          
                                     Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                                                                                          
                                 - RemoteSource[3] => [orderkey_0:bigint, linenumber:bigint, quantity:double, $hashvalue_19:bigint]                                                                                                                                      
                                                                                                                                                                                                                                                                         
 Fragment 2 [SOURCE]                                                                                                                                                                                                                                                     
     Output layout: [orderkey, $hashvalue_17]                                                                                                                                                                                                                            
     Output partitioning: HASH [orderkey][$hashvalue_17]                                                                                                                                                                                                                 
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, grouped = false, projectLocality = LOCAL] => [orderkey:bigint, $hashvalue_17:bigint]                                      
             Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                                                                            
             $hashvalue_17 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')) (3:6)                                                                                                                                                          
             orderkey := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (3:6)                                                                                                                                       
                                                                                                                                                                                                                                                                         
 Fragment 3 [SOURCE]                                                                                                                                                                                                                                                     
     Output layout: [orderkey_0, linenumber, quantity, $hashvalue_20]                                                                                                                                                                                                    
     Output partitioning: HASH [orderkey_0][$hashvalue_20]                                                                                                                                                                                                               
     Stage Execution Strategy: UNGROUPED_EXECUTION                                                                                                                                                                                                                       
     - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:lineitem', layout='Optional[example:tpch:lineitem]'}, grouped = false, projectLocality = LOCAL] => [orderkey_0:bigint, linenumber:bigint, quantity:double, $hashvalue_20:big
             Estimates: {rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                                                                                                                                            
             $hashvalue_20 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey_0), BIGINT'0')) (3:19)                                                                                                                                                       
             orderkey_0 := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (3:19)                                                                                                                                    
             quantity := ExampleColumnHandle{connectorId=example, columnName=quantity, columnType=double, ordinalPosition=4} (3:19)                                                                                                                                      
             linenumber := ExampleColumnHandle{connectorId=example, columnName=linenumber, columnType=bigint, ordinalPosition=3} (3:19)                                                                                                                                  
                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                         
(1 row)


#### case #2

explain
select o.orderkey as orderName, count(item.linenumber) as items, sum(item.quantity) as quantities
from orders as o, lineitem as item
where o.comment = item.comment
group by o.orderkey 
order by items desc 
limit 10;

                                                                                                                                                 Query Plan                                                                                            
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 - Output[orderName, items, quantities] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                 
         orderName := orderkey (1:16)                                                                                                                                                                                                                  
         items := count (1:41)                                                                                                                                                                                                                         
         quantities := sum (1:74)                                                                                                                                                                                                                      
     - TopN[10 by (count DESC_NULLS_LAST)] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                              
         - LocalExchange[SINGLE] () => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                                     
             - RemoteStreamingExchange[GATHER] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                          
                 - TopNPartial[10 by (count DESC_NULLS_LAST)] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                           
                     - Aggregate(FINAL)[orderkey] => [orderkey:bigint, count:bigint, sum:double]                                                                                                                                                       
                             count := "presto.default.count"((count_14)) (1:41)                                                                                                                                                                        
                             sum := "presto.default.sum"((sum_15)) (1:74)                                                                                                                                                                              
                         - LocalExchange[HASH][$hashvalue] (orderkey) => [orderkey:bigint, count_14:bigint, sum_15:double, $hashvalue:bigint]
                            # InnerJoin和Aggregate(FINAL)之间需要引入RemoteStreamingExchange，因为IndexJoin的join keys为comment（任务
                            # 节点间的数据partitioning columns也是这个），不符合group by keys的要求，此时需要进行shuffle。                                                                  
                             - RemoteStreamingExchange[REPARTITION][$hashvalue_16] => [orderkey:bigint, count_14:bigint, sum_15:double, $hashvalue_16:bigint]                                                                                          
                                 - Project[projectLocality = LOCAL] => [orderkey:bigint, count_14:bigint, sum_15:double, $hashvalue_22:bigint]                                                                                                         
                                         $hashvalue_22 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(orderkey), BIGINT'0')) (4:10)
                                     # InnerJoin会参与多个stream（即参与的pipeline会创建多个Driver实例），不同stream间的数据是按照列comment
                                     # 进行partition的。这意味着不同的stream经过在列orderkey上的partial aggregate后，不同的stream输出会存在
                                     # orderkey的交集。但这个不会影响最终的结果，因为final aggregate会对相同orderkey的结果再次进行聚合。
                                     # partial aggregate的主要作用是：减少shuffle数据的大小。                                                                                                       
                                     - Aggregate(PARTIAL)[orderkey] => [orderkey:bigint, count_14:bigint, sum_15:double]                                                                                                                               
                                             count_14 := "presto.default.count"((linenumber)) (1:41)                                                                                                                                                   
                                             sum_15 := "presto.default.sum"((quantity)) (1:74)                                                                                                                                                         
                                         - InnerJoin[("comment" = "comment_1")][$hashvalue_17, $hashvalue_19] => [orderkey:bigint, linenumber:bigint, quantity:double]                                                                                 
                                                 Distribution: PARTITIONED                                                                                                                                                                             
                                             - RemoteStreamingExchange[REPARTITION][$hashvalue_17] => [orderkey:bigint, comment:varchar, $hashvalue_17:bigint]                                                                                         
                                                     Estimates: {source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                           
                                                 - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:orders', layout='Optional[example:tpch:orders]'}, projectLocality = LOCAL] => [orderkey:bigint, comment:varcha
                                                         Estimates: {source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                    
                                                         $hashvalue_18 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(comment), BIGINT'0')) (2:6)                                                                                             
                                                         orderkey := ExampleColumnHandle{connectorId=example, columnName=orderkey, columnType=bigint, ordinalPosition=0} (2:6)                                                                         
                                                         comment := ExampleColumnHandle{connectorId=example, columnName=comment, columnType=varchar, ordinalPosition=8} (2:6)                                                                          
                                             - LocalExchange[HASH][$hashvalue_19] (comment_1) => [linenumber:bigint, quantity:double, comment_1:varchar, $hashvalue_19:bigint]                                                                         
                                                     Estimates: {source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                           
                                                 - RemoteStreamingExchange[REPARTITION][$hashvalue_20] => [linenumber:bigint, quantity:double, comment_1:varchar, $hashvalue_20:bigint]                                                                
                                                         Estimates: {source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: ?}                                                                                                       
                                                     - ScanProject[table = TableHandle {connectorId='example', connectorHandle='example:tpch:lineitem', layout='Optional[example:tpch:lineitem]'}, projectLocality = LOCAL] => [linenumber:bigint, quan
                                                             Estimates: {source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}/{source: CostBasedSourceInfo, rows: ? (?), cpu: ?, memory: 0.00, network: 0.00}                
                                                             $hashvalue_21 := combine_hash(BIGINT'0', COALESCE($operator$hash_code(comment_1), BIGINT'0')) (2:19)                                                                                      
                                                             comment_1 := ExampleColumnHandle{connectorId=example, columnName=comment, columnType=varchar, ordinalPosition=15} (2:19)                                                                  
                                                             quantity := ExampleColumnHandle{connectorId=example, columnName=quantity, columnType=double, ordinalPosition=4} (2:19)                                                                    
                                                             linenumber := ExampleColumnHandle{connectorId=example, columnName=linenumber, columnType=bigint, ordinalPosition=3} (2:19)                                                                
                                                                                                                                                                                                                                                       
(1 row)
